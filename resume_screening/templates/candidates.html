{% extends "screening.html" %}

{% block title %}All Candidates{% endblock %}

{% block content %}
<div class="p-9 bg-white rounded-2xl shadow-lg">
    <div class='flex justify-between items-center'>
        <p class='text-2xl text-stone-700 font-semibold'>Candidates Shortlist</p>
        <div class="flex items-center gap-2 w-[20vw] pl-3 text-stone-600 bg-stone-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-icon lucide-search"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>
            <input type="search" name="search" id="" placeholder='Search candidates...' class='text-sm p-2 w-full bg-stone-100 rounded-lg outline-none'>
        </div>
        <div class="filters flex justify-end gap-2 w-[20vw] h-full text-sm">
            <button onclick = "filterByScore('all')" class='px-4 py-2 text-stone-500 border border-stone-300 rounded-lg'>
                All
            </button>
            <button onclick = "filterByScore(80,100)" class='px-4 py-2 text-stone-500 border border-stone-300 rounded-lg'>
                80%+
            </button>
            <button onclick = "filterByScore(60,79)" class='px-4 py-2 text-stone-500 border border-stone-300 rounded-lg'>
                60-79%
            </button>
            <button onclick = "filterByScore(0,59)" class='px-4 py-2 text-stone-500 border border-stone-300 rounded-lg'>
                <60%
            </button>
        </div>
    </div>
    {% if candidates %}
    <div class="mt-6 w-full">
        <table class='w-full border-separate border-spacing-y-6'>
            <thead>
                <tr class='text-stone-500 text-[12px]'>
                    <th class='font-semibold text-start'>CANDIDATE</th>
                    <th class='text-start'>MATCH SCORE</th>
                    <th class='text-start'>KEY SKILLS</th>
                    <th class='text-start'>STATUS</th>
                    <th class='text-start'>ACTIONS</th>
                </tr>
            </thead>
            <tbody class=''>
                {% for user in users %}
                <tr class='text-stone-700'>
                    <td class='flex flex-col'>
                        <span class='text-lg font-semibold'>{{ user.name }}</span>
                        <span class='text-[12px] text-stone-500'>{{ user.email }}</span>
                    </td>
                    <td class='text-sm font-semibold'>
                        <span class='px-2 py-1 {% if user.score >= 80 %}text-green-800 bg-green-200 {% else %}text-amber-800 bg-amber-100{% endif %} rounded-lg'>
                            {{ user.score }}%
                        </span>
                    </td>
                    <td>
                        <p class='flex gap-3 text-[12px] text-stone-500'>
                            {% for skill in user.skills %}
                            <span>{{ skill }}</span>
                            {% endfor %}
                        </p>
                    </td>
                    <td>
                        <p class='text-[13px] font-semibold w-fit'>
                            {% if user.status %} <span class='text-green-800 bg-green-200 px-3 py-1 rounded-lg'>Shortlisted</span> 
                            {% else %} <span class='text-amber-800 bg-amber-100 px-3 py-1 rounded-lg'>Review</span>
                            {% endif %}
                        </p>
                    </td>
                    <td>
                        <div class='flex items-center gap-5'>
                            <a href="{{ user.resume.url }}" target="_blank" class='cursor-pointer hover:text-blue-700' title='View'>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-icon lucide-eye"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                            </a>
                            <span onclick="openEmailModal('{{ user.email }}', '{{ user.name }}')" class='cursor-pointer hover:text-blue-700' title='Contact'>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail-icon lucide-mail"><path d="m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7"/><rect x="2" y="4" width="20" height="16" rx="2"/></svg>
                            </span>
                            <span class='cursor-pointer hover:text-blue-700' title='Remove' onclick = "if(confirm('Delete this user?')) window.location.href = '{% url 'delete_user' user.id %}'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="flex justify-center gap-4">
        <button class='flex gap-2 items-center text-white text-sm font-semibold bg-blue-600 px-9 py-3 rounded-lg'>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.75" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-to-line-icon lucide-arrow-down-to-line"><path d="M12 17V3"/><path d="m6 11 6 6 6-6"/><path d="M19 21H5"/></svg>
            Export Results
        </button>
        <button class='flex gap-2 items-center text-blue-700 hover:text-white hover:bg-blue-600 text-sm font-semibold px-9 py-3 border-2 border-blue-700 rounded-lg transition-colors duration-[300ms]'>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.75" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
            Schedule Interviews
        </button>
    </div>
    {% else %}
    <p class='flex justify-center mt-9 mb-4 text-stone-400'>No Candidates</p>
    {% endif %}
</div>

<!-- Email Modal -->
<div id="emailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-9 rounded-lg w-[30vw]">
        <h3 class="text-xl text-stone-600 font-semibold mb-4">Send Email</h3>
        <form method="post" action="{% url 'send_email' %}">
            {% csrf_token %}
            <input type="hidden" name="candidate_id" id="candidate_id">
            <input type="text" name="to_email" id="to_email" class="w-full p-2 text-stone-500 border mb-3 rounded-lg" readonly>
            <input type="text" name="subject" value="Interview Invitation" class="w-full p-2 border mb-3 text-stone-700 rounded-lg">
            <textarea name="message" id="message" rows="6" class="w-full p-2 text-stone-700 border mb-3 rounded-lg"></textarea>
            <div class="flex gap-2">
                <button type="submit" class="bg-blue-600 hover:bg-blue-800 transition-colors duration-[300ms] text-white px-4 py-2 rounded-lg">Send</button>
                <button type="button" onclick="closeEmailModal()" class="bg-gray-300 hover:bg-gray-400 transition-colors duration-[300ms] px-4 py-2 rounded-lg">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% if messages %}
  <div id="toast-container" class="fixed bottom-12 right-10 space-y-2">
    {% for message in messages %}
      <p class="toast {% if 'error' in message.tags %}bg-red-500 {% else %} bg-green-500{% endif %} text-xl text-white px-4 py-2 rounded shadow">
        {{ message }}
      </p>
    {% endfor %}
  </div>
{% endif %}

{% comment %} messages transition animation {% endcomment %}
<style>
  .toast{
    opacity:0;
    transform: translateY(60px);
    animation: slideInOut 5s ease forwards;
  }
  @keyframes slideInOut{
    0%{opacity:0; transform:translateY(60px);}
    20%{opacity:1; transform:translateY(0);}
    80%{opacity:1;}
    100%{opacity:0; transform:translateY(20px);}
  }
</style>

{% comment %} search candidates  {% endcomment %}
<script>
    document.querySelector('input[name="search"]').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('tbody tr').forEach(row => {
            const name = row.querySelector('td:first-child span').textContent.toLowerCase();
            row.style.display = name.includes(query) ? '' : 'none';
        });
    });
</script>

{% comment %} filter candidates {% endcomment %}
<script>
    function filterByScore(min, max) {
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (min === 'all') {
                row.style.display = '';
                return;
            }
            
            // Get score from the score column
            const scoreText = row.querySelectorAll('td')[1].textContent.trim();
            const score = parseInt(scoreText.replace('%', ''));
            
            if (score >= min && score <= max) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>

<script>
    function openEmailModal(email, name) {
        document.getElementById('to_email').value = email;
        document.getElementById('message').value = `Hi ${name},\n\nWe reviewed your resume and would like to schedule an interview.\nScheduled Date :-\n\nBest regards`;
        document.getElementById('emailModal').classList.remove('hidden');
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.add('hidden');
    }
</script>

{% endblock %}